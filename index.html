<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Update CSV Demo</title>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 40px auto; }
        textarea { width: 100%; height: 200px; margin-top: 10px; }
        input { width: 100%; padding: 8px; margin-top: 10px; }
        button { margin-top: 10px; padding: 10px; width: 100%; }
    </style>
</head>
<body>

<h2>GitHub CSV Updater (Client-side Only)</h2>

<label>GitHub Token:</label>
<input id="token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxx">

<label>Repository (owner/repo):</label>
<input id="repo" placeholder="username/repo">

<label>CSV File Path:</label>
<input id="path" value="data.csv">

<label>CSV Content:</label>
<textarea id="content" placeholder="id,name,score&#10;1,anas,0"></textarea>

<button onclick="updateCSV()">Update CSV</button>

<p id="status"></p>

<script>
    async function updateCSV() {
        const token = document.getElementById("token").value.trim();
        const repo = document.getElementById("repo").value.trim();
        const path = document.getElementById("path").value.trim();
        const content = document.getElementById("content").value;

        if (!token || !repo || !path) {
            alert("All fields required.");
            return;
        }

        const apiURL = `https://api.github.com/repos/${repo}/contents/${path}`;

        document.getElementById("status").innerText = "Fetching existing file…";

        // Step 1: Get existing file SHA
        const getRes = await fetch(apiURL, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!getRes.ok) {
            document.getElementById("status").innerText = "Error fetching file. Does it exist?";
            return;
        }

        const fileData = await getRes.json();
        const sha = fileData.sha;

        document.getElementById("status").innerText = "Updating…";

        // Step 2: Upload new CSV content
        const updateRes = await fetch(apiURL, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Update CSV from static page",
                content: btoa(unescape(encodeURIComponent(content))), // UTF-8 safe
                sha: sha
            })
        });

        if (updateRes.ok) {
            document.getElementById("status").innerText = "CSV updated successfully!";
        } else {
            document.getElementById("status").innerText = "Update failed.";
        }
    }
</script>

</body>
</html>
